
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <link rel="shortcut icon" href="../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.7.4">
    
    
      
        <title>10. Parallel Streams - CS2030 Programming Methodology II</title>
      
    
    
      <script src="../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-769c285a91.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Gentium+Book+Basic">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../index.html" title="CS2030 Programming Methodology II" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Lectures
                </span>
              
            
            10. Parallel Streams
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/nus-cs2030/1718-s1" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    CS2030 Programming Methodology II
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/nus-cs2030/1718-s1" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../index.html" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      General
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        General
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../about/index.html" title="About" class="md-nav__link">
      About
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../prereqs/index.html" title="Prerequisites" class="md-nav__link">
      Prerequisites
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../policies/index.html" title="Policies" class="md-nav__link">
      Policies
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../schedule/index.html" title="Schedule" class="md-nav__link">
      Schedule
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../readings/index.html" title="Readings" class="md-nav__link">
      Readings
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../reviews/index.html" title="Review Qs" class="md-nav__link">
      Review Qs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../style/index.html" title="Coding Style" class="md-nav__link">
      Coding Style
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../midterm/index.html" title="Midterm" class="md-nav__link">
      Midterm
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8" checked>
    
    <label class="md-nav__link" for="nav-8">
      Lectures
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Lectures
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../lec1/index.html" title="1. Abstraction & Encapsulation" class="md-nav__link">
      1. Abstraction & Encapsulation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec2/index.html" title="2. Inheritance & Polymorphism" class="md-nav__link">
      2. Inheritance & Polymorphism
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec3/index.html" title="3. Inheritance, Continued" class="md-nav__link">
      3. Inheritance, Continued
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec4/index.html" title="4. Memory, Exceptions, Generics" class="md-nav__link">
      4. Memory, Exceptions, Generics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec5/index.html" title="5. Numbers, Strings, Collections" class="md-nav__link">
      5. Numbers, Strings, Collections
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec6/index.html" title="6. Nested Classes, Enums" class="md-nav__link">
      6. Nested Classes, Enums
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec7/index.html" title="7. Lambda and Functions" class="md-nav__link">
      7. Lambda and Functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec8/index.html" title="8. More Lambda and Streams" class="md-nav__link">
      8. More Lambda and Streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec9/index.html" title="9. Functors, Monads, Collectors" class="md-nav__link">
      9. Functors, Monads, Collectors
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        10. Parallel Streams
      </label>
    
    <a href="index.html" title="10. Parallel Streams" class="md-nav__link md-nav__link--active">
      10. Parallel Streams
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" title="Learning Objectives" class="md-nav__link">
    Learning Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallel-and-concurrent-programming" title="Parallel and Concurrent Programming" class="md-nav__link">
    Parallel and Concurrent Programming
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-concurrency" title="What is concurrency?" class="md-nav__link">
    What is concurrency?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-parallelism" title="What is parallelism?" class="md-nav__link">
    What is parallelism?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-computing" title="Parallel computing" class="md-nav__link">
    Parallel computing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallel-stream" title="Parallel Stream" class="md-nav__link">
    Parallel Stream
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-parallelize-a-stream" title="How to parallelize a stream" class="md-nav__link">
    How to parallelize a stream
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-can-be-parallelized" title="What can be parallelized?" class="md-nav__link">
    What can be parallelized?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interference" title="Interference" class="md-nav__link">
    Interference
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stateless" title="Stateless" class="md-nav__link">
    Stateless
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#side-effects" title="Side Effects" class="md-nav__link">
    Side Effects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associativity" title="Associativity" class="md-nav__link">
    Associativity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-of-parallel-stream" title="Performance of Parallel Stream" class="md-nav__link">
    Performance of Parallel Stream
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#thread-pools-and-forkjoin" title="Thread Pools and Fork/Join" class="md-nav__link">
    Thread Pools and Fork/Join
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forkjoinpool-overhead" title="ForkJoinPool overhead" class="md-nav__link">
    ForkJoinPool overhead
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ordered-vs-unordered-source" title="Ordered vs. Unordered Source" class="md-nav__link">
    Ordered vs. Unordered Source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collectors" title="Collectors" class="md-nav__link">
    Collectors
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lec11/index.html" title="11. Asynchronous Programming" class="md-nav__link">
      11. Asynchronous Programming
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Exercises
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Exercises
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../exercise1/index.html" title="1. Circles & Points" class="md-nav__link">
      1. Circles & Points
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../exercise2/index.html" title="2. Square & PaintedSquare" class="md-nav__link">
      2. Square & PaintedSquare
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../exercise3/index.html" title="3. PaintedSquare Revisited" class="md-nav__link">
      3. PaintedSquare Revisited
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../exercise4/index.html" title="4. Exceptions" class="md-nav__link">
      4. Exceptions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../exercise5/index.html" title="5. Streams" class="md-nav__link">
      5. Streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../exercise6/index.html" title="6. Functors, Collectors" class="md-nav__link">
      6. Functors, Collectors
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../exercise7/index.html" title="7. Mock Exam" class="md-nav__link">
      7. Mock Exam
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Labs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Labs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../lab1/index.html" title="1. Question" class="md-nav__link">
      1. Question
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab01-comments/index.html" title="1. Comments" class="md-nav__link">
      1. Comments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab2/index.html" title="2. Question" class="md-nav__link">
      2. Question
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab02-comments/index.html" title="2. Comments" class="md-nav__link">
      2. Comments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab3/index.html" title="3. Question" class="md-nav__link">
      3. Question
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab4/index.html" title="4. Question" class="md-nav__link">
      4. Question
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab5/index.html" title="5. Question" class="md-nav__link">
      5. Question
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab6/index.html" title="6. Question" class="md-nav__link">
      6. Question
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab7/index.html" title="7. Question" class="md-nav__link">
      7. Question
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab8/index.html" title="8. Question" class="md-nav__link">
      8. Question
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab9/index.html" title="9. Question" class="md-nav__link">
      9. Question
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab10/index.html" title="10. Question" class="md-nav__link">
      10. Question
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab11/index.html" title="11. Question" class="md-nav__link">
      11. Question
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      Software/Tools
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        Software/Tools
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../jdk/index.html" title="Java" class="md-nav__link">
      Java
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../javadoc/index.html" title="Javadoc" class="md-nav__link">
      Javadoc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../unix/index.html" title="UNIX" class="md-nav__link">
      UNIX
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vim/index.html" title="Vim" class="md-nav__link">
      Vim
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" title="Learning Objectives" class="md-nav__link">
    Learning Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallel-and-concurrent-programming" title="Parallel and Concurrent Programming" class="md-nav__link">
    Parallel and Concurrent Programming
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-concurrency" title="What is concurrency?" class="md-nav__link">
    What is concurrency?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-parallelism" title="What is parallelism?" class="md-nav__link">
    What is parallelism?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parallel-computing" title="Parallel computing" class="md-nav__link">
    Parallel computing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallel-stream" title="Parallel Stream" class="md-nav__link">
    Parallel Stream
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-parallelize-a-stream" title="How to parallelize a stream" class="md-nav__link">
    How to parallelize a stream
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-can-be-parallelized" title="What can be parallelized?" class="md-nav__link">
    What can be parallelized?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interference" title="Interference" class="md-nav__link">
    Interference
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stateless" title="Stateless" class="md-nav__link">
    Stateless
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#side-effects" title="Side Effects" class="md-nav__link">
    Side Effects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associativity" title="Associativity" class="md-nav__link">
    Associativity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-of-parallel-stream" title="Performance of Parallel Stream" class="md-nav__link">
    Performance of Parallel Stream
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#thread-pools-and-forkjoin" title="Thread Pools and Fork/Join" class="md-nav__link">
    Thread Pools and Fork/Join
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forkjoinpool-overhead" title="ForkJoinPool overhead" class="md-nav__link">
    ForkJoinPool overhead
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ordered-vs-unordered-source" title="Ordered vs. Unordered Source" class="md-nav__link">
    Ordered vs. Unordered Source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collectors" title="Collectors" class="md-nav__link">
    Collectors
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/nus-cs2030/1718-s1/edit/master/docs/lec10.md" title="Edit this page" class="md-icon md-content__icon">edit</a>
                
                
                <h1 id="lecture-10-parallel-streams">Lecture 10: Parallel Streams</h1>
<h2 id="learning-objectives">Learning Objectives</h2>
<p>After attending this lecture, students should:</p>
<ul>
<li>be aware that a program can be broken into subtasks to run parallelly and/or concurrently </li>
<li>be aware of the issues caused by running the subtasks parallelly and concurrently.</li>
<li>be aware of that there exist tradeoffs in the number of subtasks and the processing overhead.</li>
<li>be familiar with how to process a stream parallelly and correctly.</li>
<li>be familiar with the Java's fork/join framework. </li>
</ul>
<h2 id="parallel-and-concurrent-programming">Parallel and Concurrent Programming</h2>
<p>So far, the programs that we have written in CS2030 run <em>sequentially</em>.  What this means is that at any one time, there is only one instruction of the program running on a processor.  </p>
<h3 id="what-is-concurrency">What is concurrency?</h3>
<p>A single core processor can only execute one instruction at one time -- this means that only one <em>process</em>  (or less precisely speaking, one application) can run at any one time.  Yet, when we use the computer, it <em>feels</em> as if we are running multiple processes at the same time.  The operating system, behind the scene, is actually switching between the different processes, to give the user an illusion that they are running at the same time.</p>
<p>We can write a program so that it runs concurrently -- by dividing the computation into subtasks called <em>threads</em>.  The operating system, behind the scene, can switch between the different threads, to give the user an illusion that the threads are running at the same time.  Such multi-threads programs are useful in two ways: (i) it allows us, the programmers, to separate the unrelated tasks into threads, and write each thread separately; (ii) it improves the utilization of the processor.  For instance, if I/O is in one thread, and UI rendering is in another, then when the processor is waiting for I/O to complete, it can switch to the rendering thread to make sure that the slow I/O does not affect the responsiveness of UI.</p>
<h3 id="what-is-parallelism">What is parallelism?</h3>
<p>While concurrency gives the illusion of subtasks running at the same time, parallel computing refers to the scenario where multiple subtasks are truly running at the same time -- either we have a processor that is capable of running multiple instructions at the same time, or we have multiple cores / processors and dispatch the instructions to the cores / processors so that they are executed at the same time.</p>
<p>All parallel programs are concurrent, but not all concurrent programs are parallel.</p>
<p>Modern computers have more than one cores / processors<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.
As such, the line between parallelism and concurrency is blurred.  </p>
<h3 id="parallel-computing">Parallel computing</h3>
<p>Parallel computing is one of the major topics in computer science.  One can teach a whole module (or a focus area) on this topic alone.  The goal of this lecture is not to cover it in depth, but is to expose students in CS2030 to the concept of parallel computing in relation to the stream abstraction in Java 8.</p>
<h2 id="parallel-stream">Parallel Stream</h2>
<p>We have seen that Java <code class="codehilite">Stream</code> class is a powerful and useful class for processing data in declarative style.  But, we have not fully unleash the power of <code class="codehilite">Stream</code>.  The neatest thing about <code class="codehilite">Stream</code> is that it allows parallel operations on the elements of the stream in one single line of code.  </p>
<p>Let's consider the following program that prints out all the prime numbers between 1 and 999,999.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1_000_000</span><span class="o">)</span>
        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<p>We can parallelize the code by adding the call <code class="codehilite">parallel()</code> into the stream.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1_000_000</span><span class="o">)</span>
        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
        <span class="o">.</span><span class="na">parallel</span><span class="o">()</span>
        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<p>You may observe that the output has been reordered, although the same set of numbers are still being produced.  This is because <code class="codehilite">Stream</code> has broken down the numbers into subsequences, and run <code class="codehilite">filter</code> and <code class="codehilite">forEach</code> for each subsequences in parallel.  Since there is no coordination among the parallel tasks on the order of the printing, whichever parallel tasks that complete first will output the result to screen first, causing the sequence of numbers to be reordered.</p>
<p>If you want to produce the output in the order of input, use <code class="codehilite">forEachOrdered</code> instead of <code class="codehilite">forEach</code>, we will loose some benefits of parallelization because of this.</p>
<p>Suppose now that we want to compute the number of primes below 1,000,000.  We can run:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1_000_000</span><span class="o">)</span>
        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
        <span class="o">.</span><span class="na">parallel</span><span class="o">()</span>
        <span class="o">.</span><span class="na">count</span><span class="o">()</span>
</pre></div>
</td></tr></table>

<p>The code above produce the same output regardless of it is being parallelized or not.  </p>
<p>Note that the task above is stateless and does not produce any side effect.  Furthermore, each element is processed individually without depending on other elements.  Such computation is sometimes known as <em>embarrassingly parallel</em>.  The only communication needed for each of the parallel subtask is to combine the result of <code class="codehilite">count()</code> from the subtasks into the final count (which has been implemented in <code class="codehilite">Stream</code> for us.</p>
<h3 id="how-to-parallelize-a-stream">How to parallelize a stream</h3>
<p>You have seen that adding <code class="codehilite">parallel()</code> to the chain of calls in a stream enables parallel processing of the stream.  Note that <code class="codehilite">parallel()</code> is a lazy operation -- it merely marks the stream to be process in parallel.  As such, you can insert the call to <code class="codehilite">parallel()</code> anywhere in the chain.</p>
<div class="admonition note">
<p class="admonition-title">sequential()</p>
<p>There is a method <code class="codehilite">sequential()</code> which marks the stream to be process sequentially.  If you call both <code class="codehilite">parallel()</code> and <code class="codehilite">sequential()</code> in a stream,
the last call "wins".  The example below processes the stream 
sequentially:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>s.parallel().filter(x -&gt; x &lt; 0).sequential().forEach(..); 
</pre></div>
</td></tr></table></p>
</div>
<p>Another way to create a parallel stream is to call the method <code class="codehilite">parallelStream()</code> instead of <code class="codehilite">stream()</code> of the <code class="codehilite">Collector</code> class.  Doing so would create a stream that will be processed in parallel from the collection.</p>
<h3 id="what-can-be-parallelized">What can be parallelized?</h3>
<p>To ensure that the output of the parallel execution is correct, the stream operations must not <em>interfere</em> with the stream data, and most of time must be <em>stateless</em>.  Side-effects should be kept to minimum.</p>
<h3 id="interference">Interference</h3>
<p>Interference means that one of the stream operation modifies the source of the stream during the execution of the terminal operation.  For instance:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;Luke&quot;</span><span class="o">,</span> <span class="s">&quot;Leia&quot;</span><span class="o">,</span> <span class="s">&quot;Han&quot;</span><span class="o">));</span>
<span class="n">list</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
    <span class="o">.</span><span class="na">peek</span><span class="o">(</span><span class="n">name</span> <span class="o">-&gt;</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Han&quot;</span><span class="o">))</span> <span class="o">{</span>
           <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;Chewie&quot;</span><span class="o">);</span> <span class="c1">// they belong together</span>
         <span class="o">}</span>
      <span class="o">})</span>
    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{});</span>
</pre></div>
</td></tr></table>

<p>Would cause <code class="codehilite">ConcurrentModificationException</code> to be thrown.  Note that this non-interference rule applies even if we are using <code class="codehilite">stream()</code> instead of <code class="codehilite">parallelStream()</code>.</p>
<h3 id="stateless">Stateless</h3>
<p>A stateful lambda is one where the result depends on any state that might change during the execution of stream.</p>
<p>For instance, the <code class="codehilite">generate</code> and <code class="codehilite">map</code> operations below are stateful, since they depend on the events in the queue and the states of the shops.  Parallelizing this may lead to incorrect output.  To ensure that the output is correct, additional work needs to be done to ensure that state updates are visible to all parallel subtasks.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Stream</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">events</span><span class="o">::</span><span class="n">poll</span><span class="o">)</span>
    <span class="o">.</span><span class="na">takeWhile</span><span class="o">(</span><span class="n">event</span> <span class="o">-&gt;</span> <span class="n">event</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">event</span> <span class="o">-&gt;</span> <span class="n">event</span><span class="o">.</span><span class="na">happensBefore</span><span class="o">(</span><span class="n">sim</span><span class="o">.</span><span class="na">expireTime</span><span class="o">()))</span> 
    <span class="o">.</span><span class="na">peek</span><span class="o">(</span><span class="n">event</span> <span class="o">-&gt;</span> <span class="n">event</span><span class="o">.</span><span class="na">log</span><span class="o">())</span>
    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">event</span> <span class="o">-&gt;</span> <span class="n">sim</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">event</span><span class="o">))</span>
    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">eventStream</span> <span class="o">-&gt;</span> <span class="k">this</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="n">eventStream</span><span class="o">));</span>
</pre></div>
</td></tr></table>

<h3 id="side-effects">Side Effects</h3>
<p>Side-effects can lead to incorrect results in parallel execution.  Consider the following code:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span>
    <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">7</span><span class="o">,</span><span class="mi">9</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span><span class="mi">13</span><span class="o">,</span><span class="mi">15</span><span class="o">,</span><span class="mi">17</span><span class="o">,</span><span class="mi">19</span><span class="o">));</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">list</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">()</span>
    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">x</span><span class="o">));</span>
</pre></div>
</td></tr></table>

<p>The <code class="codehilite">forEach</code> lambda generates a side effect -- it modifies <code class="codehilite">result</code>.  <code class="codehilite">ArrayList</code> is what we call a non-thread-safe data structure.  If two threads manipulate it at the same time, incorrect result may result.</p>
<p>If we use <code class="codehilite">Collectors.toList()</code> instead, we can achieve the intended result without visible side effects.</p>
<h3 id="associativity">Associativity</h3>
<p>The <code class="codehilite">reduce</code> operation is inherently parallelizable, as we can easily reduce each sub-streams and then use the <code class="codehilite">combiner</code> to combine the results together.  Recall this example from Lecture 9:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">).</span><span class="na">reduce</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)-&gt;</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">,</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">)-&gt;</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<p>There are several rules that the <code class="codehilite">identity</code>, the <code class="codehilite">accumulator</code> and the <code class="codehilite">combiner</code> must follow:</p>
<ul>
<li><code class="codehilite">combiner.apply(identity, i)</code> must be equal to <code class="codehilite">i</code>.</li>
<li>The <code class="codehilite">combiner</code> and the <code class="codehilite">accumulator</code> must be associative -- the order of applying must not matter.</li>
<li>The <code class="codehilite">combiner</code> and the <code class="codehilite">accumulator</code> must be compatible -- <code class="codehilite">combiner.apply(u, accumulator.apply(identity, t))</code> must equal to <code class="codehilite">accumulator.apply(u, t)</code></li>
</ul>
<p>The multiplication example above meetings the three rules:</p>
<ul>
<li><code class="codehilite">i * 1</code> equals <code class="codehilite">i</code></li>
<li><code class="codehilite">(x * y) * z</code> equals <code class="codehilite">x * (y * z)</code></li>
<li><code class="codehilite">u * (1 * t)</code> equals <code class="codehilite">u * t</code></li>
</ul>
<h2 id="performance-of-parallel-stream">Performance of Parallel Stream</h2>
<p>Let's go back to:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1_000_000</span><span class="o">)</span>
    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
    <span class="o">.</span><span class="na">parallel</span><span class="o">()</span>
    <span class="o">.</span><span class="na">count</span><span class="o">()</span>
</pre></div>
</td></tr></table>

<p>How much time can we save by parallelizing the code above?</p>
<p>Let's use the <a href="https://docs.oracle.com/javase/9/docs/api/java/time/Instant.html"><code class="codehilite">Instant</code></a> and <a href="https://docs.oracle.com/javase/9/docs/api/java/time/Duration.html"><code class="codehilite">Duration</code></a> class from Java to help us:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">Instant</span> <span class="n">start</span> <span class="o">=</span> <span class="n">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">howMany</span> <span class="o">=</span> <span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1000000</span><span class="o">)</span>
        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">isPrime</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
        <span class="o">.</span><span class="na">parallel</span><span class="o">()</span>
        <span class="o">.</span><span class="na">count</span><span class="o">();</span>
    <span class="n">Instant</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">howMany</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">Duration</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="n">start</span><span class="o">,</span><span class="n">stop</span><span class="o">).</span><span class="na">toMillis</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; ms&quot;</span><span class="o">);</span>
</pre></div>
</td></tr></table>

<p>The code above measures roughly the time it takes to count the number of primes below 1,000,000.  On my iMac, it takes about 300-320 ms.  If I remove <code class="codehilite">parallel()</code>, it takes about 500 ms.  So we gain about 36 - 40% performance.</p>
<p>Can we parallelize some more?  Remember how we implement <code class="codehilite">isPrime</code><sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">noneMatch</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">%</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="o">);</span>
  <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Let's parallelize this to make this even faster!</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="kt">boolean</span> <span class="nf">isPrime</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">parallel</span><span class="o">()</span>
        <span class="o">.</span><span class="na">noneMatch</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">%</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="o">);</span>
  <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>If you run the code above, however, you will find that the code is not as fast as we expect. On my iMac, it takes about 12.7s, about 25 times slower!</p>
<p><em>Parallelizing a stream does not always improve the performance</em>.</p>
<p>What is going on?  To understand this, we have to delve a bit deeper into how Java implements the parallel streams.  </p>
<h3 id="thread-pools-and-forkjoin">Thread Pools and Fork/Join</h3>
<p>Internally, Java maintains pool of <em>worker threads</em>.  A worker thread is an abstraction for running a task.  We can submit a task to the pool for execution, the task will join queue.  The worker thread can pick a task from the queue to execute.  When it is done, it pick another task, if one exists in the queue, and so on -- not unlike our <code class="codehilite">Server</code> (worker thread) and <code class="codehilite">Customer</code> (task).</p>
<p>A <code class="codehilite">ForkJoinPool</code> is a class the implements a thread pool with a particular semantic --- the task that the worker runs must specify <code class="codehilite">fork</code> -- how to create subtasks, and <code class="codehilite">join</code> -- how to merge the results from the subtasks.</p>
<p>In the case of a parallel stream, <code class="codehilite">fork</code> will create subtasks running the same chain of operations on sub-streams, and when done, run <code class="codehilite">join</code> to combine the results (e.g., <code class="codehilite">combiner</code> for <code class="codehilite">reduce</code> is run in <code class="codehilite">join</code>).  <code class="codehilite">fork</code> and <code class="codehilite">join</code> can be recursive -- for instance, a <code class="codehilite">fork</code> operation can split the stream into two subtasks.  The subtasks can further split the sub-streams into four smaller sub-streams, and so on, until the size of the sub-stream is small enough that the task is actually invoked.</p>
<p>To define a task, we subclass from <code class="codehilite">RecursiveTask&lt;T&gt;</code> (if the task returns a value of type <code class="codehilite">T</code>) or <code class="codehilite">RecursiveAction</code> (if the task does not return a value).</p>
<p>Here is an example task that we can submit to ForkJoinPool:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BinSearch</span> <span class="kd">extends</span> <span class="n">RecursiveTask</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">FORK_THRESHOLD</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">low</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">high</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">toFind</span><span class="o">;</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">array</span><span class="o">;</span>

    <span class="n">BinSearch</span><span class="o">(</span><span class="kt">int</span> <span class="n">low</span><span class="o">,</span> <span class="kt">int</span> <span class="n">high</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toFind</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">array</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">low</span> <span class="o">=</span> <span class="n">low</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">high</span> <span class="o">=</span> <span class="n">high</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">toFind</span> <span class="o">=</span> <span class="n">toFind</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Boolean</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">// stop splitting into subtask if array is already small.</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="n">FORK_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">low</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">high</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">array</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">==</span> <span class="n">toFind</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="o">}</span> 

      <span class="kt">int</span> <span class="n">middle</span> <span class="o">=</span> <span class="o">(</span><span class="n">low</span> <span class="o">+</span> <span class="n">high</span><span class="o">)/</span><span class="mi">2</span><span class="o">;</span>
      <span class="n">BinSearch</span> <span class="n">left</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BinSearch</span><span class="o">(</span><span class="n">low</span><span class="o">,</span> <span class="n">middle</span><span class="o">,</span> <span class="n">toFind</span><span class="o">,</span> <span class="n">array</span><span class="o">);</span>
      <span class="n">BinSearch</span> <span class="n">right</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BinSearch</span><span class="o">(</span><span class="n">middle</span><span class="o">,</span> <span class="n">high</span><span class="o">,</span> <span class="n">toFind</span><span class="o">,</span> <span class="n">array</span><span class="o">);</span>
      <span class="n">left</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
      <span class="k">return</span> <span class="n">right</span><span class="o">.</span><span class="na">compute</span><span class="o">()</span> <span class="o">||</span> <span class="n">left</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>To run the task, we call the <code class="codehilite">invoke</code> method of <code class="codehilite">ForkJoinPool</code>, which executes the given task immediately and return the result.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">BinSearch</span> <span class="n">searchTask</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BinSearch</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="mi">12</span><span class="o">,</span> <span class="n">array</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">found</span> <span class="o">=</span> <span class="n">ForkJoinPool</span><span class="o">.</span><span class="na">commonPool</span><span class="o">().</span><span class="na">invoke</span><span class="o">(</span><span class="n">searchTask</span><span class="o">)</span>
</pre></div>
</td></tr></table>

<p>The task above recursively search for an element in the left half and right half of the array.  Note that this is similar to, but is NOT binary search.  Binary search of course just search in either the left or the right side, depending on the middle value, and is not parallel.</p>
<h3 id="forkjoinpool-overhead">ForkJoinPool overhead</h3>
<p>In the example above, you can see that creating subtasks incur some overhead (new task objects, copying of parameters into objects, etc).  In the <code class="codehilite">isPrime</code> example above, the task is trivial (checking <code class="codehilite">n % x == 0</code>), and so, by parallelizing it, we are actually creating more work for Java to do!  It is much more efficient if we simply check for <code class="codehilite">n % x == 0</code> sequentially.</p>
<p>The moral of the story is, parallelization is worthwhile if the task is complex enough that the benefit of parallelization outweighs the overhead.  While we discuss this in the context of parallel streams, this principle holds for all parallel and concurrent programs.</p>
<h3 id="ordered-vs-unordered-source">Ordered vs. Unordered Source</h3>
<p>Whether or not the stream elements are <em>ordered</em> or <em>unordered</em> also plays a role in the performance of parallel stream operations.  A stream may define an <em>encounter order</em>.  Streams created from <code class="codehilite">iterate</code>, ordered collections (e.g., <code class="codehilite">List</code> or arrays), from <code class="codehilite">of</code>, are ordered.  Stream created from <code class="codehilite">generate</code> or unordered collections (e.g., <code class="codehilite">Set</code>) are unordered.</p>
<p>Some stream operations respect the encounter order.  For instance, both <code class="codehilite">distinct</code> and <code class="codehilite">sorted</code> preserve the original order of elements (if ordering is preserved, we say that an operation is <em>stable</em>).</p>
<p>The parallel version of <code class="codehilite">findFirst</code>, <code class="codehilite">limit</code>, and <code class="codehilite">skip</code> can be expensive on ordered stream.  </p>
<p>If we have an ordered stream and respecting the original order is not important, we can call <code class="codehilite">unordered()</code> as part of the chain command to make the parallel operations much more efficient.</p>
<p>The following, for example, takes about 700 ms on my iMac:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">Stream</span><span class="o">.</span><span class="na">iterate</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="o">)</span>
        <span class="o">.</span><span class="na">parallel</span><span class="o">()</span>
        <span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">10_000_000</span><span class="o">)</span>
        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">64</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="o">.</span><span class="na">forEachOrdered</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="o">});</span>
</pre></div>
</td></tr></table>

<p>But, with <code class="codehilite">unordered()</code> inserted, it takes about 350ms, a 2x speed up!</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">Stream</span><span class="o">.</span><span class="na">iterate</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="o">)</span>
        <span class="o">.</span><span class="na">parallel</span><span class="o">()</span>
        <span class="o">.</span><span class="na">unordered</span><span class="o">()</span>
        <span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">10_000_000</span><span class="o">)</span>
        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">64</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="o">.</span><span class="na">forEachOrdered</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="o">});</span>
</pre></div>
</td></tr></table>

<h3 id="collectors">Collectors</h3>
<p>To wrap up, we will revisit the <code class="codehilite">Collector</code> class.  Recall that <code class="codehilite">collect</code> is a mutable version of <code class="codehilite">reduce</code> on <code class="codehilite">Stream</code>.  Being mutable, parallelizing it is tricky.  Luckily, we only need to provide hints to the Collector class, which will optimize the implementation for us.  The hint is given as part of the <code class="codehilite">characteristics()</code> method (the last method that we did not cover last week).</p>
<p>The <code class="codehilite">characteristics()</code> method returns a <code class="codehilite">Set</code> that contains a combination of three enums:</p>
<ul>
<li><code class="codehilite">CONCURRENT</code> to indicate that the container that the supplier created can support accumulator function being called concurrently from multiple threads,</li>
<li><code class="codehilite">IDENTITY_FINISH</code> to indicate the the finisher function is the identity function, and can be skipped.</li>
<li><code class="codehilite">UNORDERED</code> to indicate that the collection operation does not necessary preserve the encounter order of the elements.</li>
</ul>
<p>The operation <code class="codehilite">collect</code> will only be parallelized if the following three conditions hold:</p>
<ul>
<li>The stream is parallel</li>
<li>The collector has characteristic <code class="codehilite">CONCURRENT</code> </li>
<li>The stream is unordered or has characteristic <code class="codehilite">UNORDERED</code></li>
</ul>
<p>Of course, if we tell the collector has the characteristic <code class="codehilite">CONCURRENT</code>, the container that we use must actually supports that!  Luckily for us, Java <code class="codehilite">java.util.concurrent</code> package provides many collections that support concurrency, including <code class="codehilite">CopyOnWriteArrayList</code>, <code class="codehilite">ConcurrentHashMap</code>, etc.  Obviously these are more expensive.  For instance, <code class="codehilite">CopyOnWriteArrayList</code> creates a fresh copy of the underlying array whenever there is a mutative operation (e.g., <code class="codehilite">add</code>, <code class="codehilite">set</code>, etc), not unlike your <code class="codehilite">LambdaList</code>.  </p>
<p>Again, this is the overhead cost of parallelization -- the cost that might not outweigh the benefit of parallelization, and should be considered carefully.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>iPhone X comes with A11 Bionic chip with six cores.  The fastest supercomputer in the world as of this writing, the Sunway TaihuLight ( ), has 40,960 processors, each with 256 cores, giving a total of 10,485,760 cores.  &#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>This is a more efficient version of the code you have seen, since it stops testing after the square root of the <span>\(n\)</span>.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../lec9/index.html" title="9. Functors, Monads, Collectors" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                9. Functors, Monads, Collectors
              </span>
            </div>
          </a>
        
        
          <a href="../lec11/index.html" title="11. Asynchronous Programming" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                11. Asynchronous Programming
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright by Wei Tsang Ooi, Department of Computer Science, National University of Singapore 2017
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-c35428f87f.js"></script>
      
      
      <script>app.initialize({url:{base:".."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>